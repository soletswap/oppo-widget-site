<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oppo Jupiter Ultra Swap Widget</title>

  <!-- Jupiter Plugin -->
  <script src="https://plugin.jup.ag/plugin-v1.js" defer></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: clamp(24px, 4vw, 36px);
      margin: 0 0 10px 0;
      background: linear-gradient(135deg, #89d5dc 0%, #6bb1b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      font-size: 16px;
      opacity: 0.8;
      margin: 0;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
      align-items: start;
    }

    @media (min-width: 768px) {
      .main-content {
        grid-template-columns: 1fr 350px;
      }
    }

    .widget-section {
      order: 1;
    }

    @media (min-width: 768px) {
      .widget-section {
        order: 2;
      }
    }

    #target-container {
      width: 100%;
      max-width: 400px;
      height: 568px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-section {
      order: 2;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 24px;
    }

    @media (min-width: 768px) {
      .info-section {
        order: 1;
      }
    }

    .info-card {
      background: rgba(137, 213, 220, 0.1);
      border: 1px solid rgba(137, 213, 220, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .info-card h3 {
      color: #89d5dc;
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 600;
    }

    .info-card p, .info-card ul {
      margin: 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .info-card ul {
      padding-left: 20px;
    }

    .info-card li {
      margin-bottom: 8px;
    }

    .fee-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.3);
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 16px;
    }

    .fee-display .label {
      font-weight: 600;
      color: #89d5dc;
    }

    .fee-display .value {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      opacity: 0.8;
    }

    .token-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }

    .token-badge {
      background: rgba(137, 213, 220, 0.2);
      border: 1px solid rgba(137, 213, 220, 0.3);
      border-radius: 6px;
      padding: 6px 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #89d5dc;
    }

    button {
      margin-top: 15px;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #89d5dc 0%, #6bb1b8 100%);
      color: #0c0c0c;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(137, 213, 220, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    .status-message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .status-message.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    .status-message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .status-message.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }

    @media (max-width: 767px) {
      body {
        padding: 15px;
      }
      
      .header h1 {
        font-size: 28px;
      }
      
      #target-container {
        max-width: 100%;
        height: auto;
        min-height: 500px;
      }
      
      .info-section {
        margin-top: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Oppo Jupiter Ultra Swap</h1>
      <p>Decentralized token swapping with Jupiter Ultra API referral fees</p>
    </header>

    <div class="main-content">
      <div class="info-section">
        <div class="info-card">
          <h3>🚀 Referral Fee Integration</h3>
          <p>Jupiter Ultra API with optimized fee distribution:</p>
          <div class="fee-display">
            <span class="label">Protocol Share:</span>
            <span class="value">80%</span>
          </div>
          <div class="fee-display">
            <span class="label">Jupiter Share:</span>
            <span class="value">20%</span>
          </div>
          <div class="fee-display">
            <span class="label">Referral Account:</span>
            <span class="value">9EvV3V9cZ4KktQ4xCnu3ymA2a9qgaBR4HLFhFddZZXSn</span>
          </div>
        </div>

        <div class="info-card">
          <h3>💰 Supported Tokens</h3>
          <p>Swap fees applied to these premium tokens:</p>
          <div class="token-list">
            <div class="token-badge">SOL</div>
            <div class="token-badge">USDC</div>
            <div class="token-badge">USDT</div>
            <div class="token-badge">JUP</div>
            <div class="token-badge">RAY</div>
            <div class="token-badge">mSOL</div>
            <div class="token-badge">JupSOL</div>
            <div class="token-badge">SSOL</div>
            <div class="token-badge">JitoSOL</div>
            <div class="token-badge">ETH</div>
            <div class="token-badge">EURC</div>
            <div class="token-badge">USDG</div>
            <div class="token-badge">PUMP</div>
          </div>
        </div>

        <div class="info-card">
          <h3>⚡ Ultra Features</h3>
          <ul>
            <li>Real-time fee tracking</li>
            <li>Unclaimed fee monitoring</li>
            <li>$1 minimum claim threshold</li>
            <li>Verified/non-verified claim logic</li>
            <li>Mobile & desktop optimized</li>
          </ul>
        </div>

        <button id="claimFeesBtn">Check Unclaimed Fees</button>
        <div id="statusMessage" class="status-message"></div>
      </div>

      <div class="widget-section">
        <div id="target-container">
          <!-- Jupiter Widget will be loaded here -->
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: rgba(137, 213, 220, 0.1); border-radius: 16px; padding: 20px; text-align: center;">
            <div>
              <div style="font-size: 18px; margin-bottom: 10px;">🚀 Jupiter Ultra Widget</div>
              <div style="font-size: 14px; opacity: 0.8;">Loading Jupiter plugin...</div>
              <div style="font-size: 12px; opacity: 0.6; margin-top: 10px;">Please ensure you have internet connection</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Jupiter Ultra API Configuration
    // Referral fee configuration according to requirements
    const REFERRAL_CONFIG = {
      feeBps: 20, // 0.2% referral fee (20 basis points)
      feeRecipient: "9EvV3V9cZ4KktQ4xCnu3ymA2a9qgaBR4HLFhFddZZXSn", // Specified referral account
      ultraFeeShare: {
        protocol: 80, // 80% to protocol
        jupiter: 20   // 20% to Jupiter
      }
    };

    // Supported token mint addresses for fee application
    const SUPPORTED_TOKENS = {
      SOL: "So11111111111111111111111111111111111111112",      // Native SOL (Wrapped)
      USDC: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",    // USD Coin
      USDT: "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB",    // Tether USD
      JUP: "JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN",     // Jupiter
      RAY: "4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R",     // Raydium
      mSOL: "mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So",    // Marinade SOL
      JupSOL: "jupSoLaHXQiZZTSfEWMTRRgpnyFm8f6sZdosWBjx93v", // Jupiter SOL
      SSOL: "7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj",    // Solana Staked SOL
      JitoSOL: "J1toso1uCk3RLmjorhTtrVwY9HJ7X8V9yYac6Y7kGCPn", // Jito SOL
      ETH: "7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs",     // Ethereum (Wormhole)
      EURC: "HzwqbKZw8HxMN6bF2yFZNrht3c2iXXzpKcFu7uBEDKtr",   // Euro Coin
      // TODO: Add correct mint addresses for USDG and PUMP tokens
      USDG: "USDBo9U2rnTBJBwEkQKKPkBjW7w24vfVQzQqW1RV4iAu",    // Placeholder - needs verification
      PUMP: "PUMPXrGkYu7HQUqw9FgGqHHqENDQ2FtjNNgJf6qWqum"     // Placeholder - needs verification
    };

    // Status message utility functions
    function showStatusMessage(message, type = 'info') {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status-message ${type}`;
      statusEl.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 5000);
    }

    // Jupiter Ultra API fee handling
    async function handleUltraReferralFee(transactionSignature) {
      try {
        showStatusMessage('Processing referral fee with Jupiter Ultra API...', 'info');
        
        // Check if running in offline/demo mode
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log("🔄 Demo mode: Simulating Jupiter Ultra API call", {
            transaction: transactionSignature,
            feeBps: REFERRAL_CONFIG.feeBps,
            feeRecipient: REFERRAL_CONFIG.feeRecipient
          });
          
          // Simulate API delay
          await new Promise(resolve => setTimeout(resolve, 1500));
          
          showStatusMessage('✅ Referral fee successfully processed! (Demo Mode)', 'success');
          return;
        }
        
        // Import Jupiter Ultra API (only in production)
        const { addFeesToUltra } = await import('https://cdn.jsdelivr.net/npm/@jup-ag/ultra-api/dist/ultra-api.min.js');
        
        // Add fees to Ultra with configured parameters
        await addFeesToUltra({
          transaction: transactionSignature,
          feeBps: REFERRAL_CONFIG.feeBps,
          feeRecipient: REFERRAL_CONFIG.feeRecipient,
          // Ultra fee distribution configuration
          ultraFeeConfig: {
            protocolShare: REFERRAL_CONFIG.ultraFeeShare.protocol,
            jupiterShare: REFERRAL_CONFIG.ultraFeeShare.jupiter
          }
        });
        
        console.log("✅ Jupiter Ultra referral fee successfully processed!", {
          transaction: transactionSignature,
          feeBps: REFERRAL_CONFIG.feeBps,
          feeRecipient: REFERRAL_CONFIG.feeRecipient
        });
        
        showStatusMessage('✅ Referral fee successfully processed!', 'success');
        
      } catch (error) {
        console.error("❌ Jupiter Ultra fee processing error:", error);
        
        // Handle network errors gracefully in demo mode
        if (error.message.includes('Failed to fetch') || error.message.includes('ERR_BLOCKED_BY_CLIENT')) {
          showStatusMessage('⚠️ Demo mode: Network restricted, simulating success', 'info');
          console.log("🔄 Network restricted, running in demo mode");
        } else {
          showStatusMessage(`❌ Fee processing failed: ${error.message}`, 'error');
        }
        
        // Log detailed error for debugging
        console.error("Error details:", {
          error: error,
          transaction: transactionSignature,
          config: REFERRAL_CONFIG
        });
      }
    }

    // Ultra Referral Token Account integration
    async function checkUnclaimedFees() {
      try {
        showStatusMessage('Checking unclaimed fees...', 'info');
        
        // Check if running in offline/demo mode
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log("🔄 Demo mode: Simulating unclaimed fees check");
          
          // Simulate API delay
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Simulate unclaimed fees data
          const demoFees = {
            total: 0.0045, // 0.0045 SOL
            totalUSD: 0.85, // Below $1 threshold
            verified: true,
            tokens: [
              { symbol: 'SOL', amount: 0.0045, usdValue: 0.85 }
            ]
          };
          
          showStatusMessage(`💰 Demo: Unclaimed fees $${demoFees.totalUSD.toFixed(2)} (Below $1 minimum)`, 'info');
          return;
        }
        
        // Import necessary Jupiter Ultra functions (only in production)
        const { getUnclaimedFees, claimFees } = await import('https://cdn.jsdelivr.net/npm/@jup-ag/ultra-api/dist/ultra-api.min.js');
        
        // Get unclaimed fees for the referral account
        const unclaimedFees = await getUnclaimedFees({
          referralAccount: REFERRAL_CONFIG.feeRecipient
        });
        
        console.log("Unclaimed fees:", unclaimedFees);
        
        if (unclaimedFees && unclaimedFees.total > 0) {
          const totalUSD = unclaimedFees.totalUSD || 0;
          
          // Check if meets minimum claim threshold ($1)
          if (totalUSD >= 1.0) {
            showStatusMessage(`💰 Unclaimed fees: $${totalUSD.toFixed(2)} (Ready to claim)`, 'success');
            
            // Auto-claim if verified and above threshold
            if (unclaimedFees.verified) {
              await claimFees({
                referralAccount: REFERRAL_CONFIG.feeRecipient,
                claimAll: true
              });
              showStatusMessage('✅ Fees successfully claimed!', 'success');
            } else {
              showStatusMessage(`⚠️ Unclaimed fees: $${totalUSD.toFixed(2)} (Verification pending)`, 'info');
            }
          } else {
            showStatusMessage(`💰 Unclaimed fees: $${totalUSD.toFixed(2)} (Below $1 minimum)`, 'info');
          }
        } else {
          showStatusMessage('No unclaimed fees available', 'info');
        }
        
      } catch (error) {
        console.error("Error checking unclaimed fees:", error);
        
        // Handle network errors gracefully in demo mode
        if (error.message.includes('Failed to fetch') || error.message.includes('ERR_BLOCKED_BY_CLIENT')) {
          showStatusMessage('⚠️ Demo mode: Network restricted, showing simulated data', 'info');
          console.log("🔄 Network restricted, showing demo unclaimed fees data");
        } else {
          showStatusMessage(`❌ Failed to check fees: ${error.message}`, 'error');
        }
      }
    }

    // Jupiter Widget initialization with Ultra API integration
    document.addEventListener("DOMContentLoaded", () => {
      // Wait for Jupiter plugin to load
      const initWidget = () => {
        if (typeof window.Jupiter === 'undefined') {
          console.log('Waiting for Jupiter plugin to load...');
          setTimeout(initWidget, 500);
          return;
        }

        try {
          // Initialize Jupiter widget with Oppo branding and referral configuration
          window.Jupiter.init({
            displayMode: "integrated",
            integratedTargetId: "target-container",
            endpoint: "https://api.jup.ag/", // Jupiter API endpoint
            
            // Form configuration
            formProps: {
              initialInputMint: SUPPORTED_TOKENS.SOL,  // Default to SOL
              initialOutputMint: SUPPORTED_TOKENS.USDC, // Default to USDC
              fixedInputMint: false, // Allow users to change input token
              fixedOutputMint: false, // Allow users to change output token
              swapMode: "ExactIn", // Standard swap mode
              
              // Restrict to supported tokens for fee application
              strictTokenList: false,
              defaultExplorer: "SolanaFM"
            },
            
            // Oppo branding configuration
            branding: {
              logoUri: "https://photos.pinksale.finance/file/pinksale-logo-upload/1733923962272-6c08b5b4359a38ef4991bd3d69dc1c3d.png",
              name: "Oppo",
              colors: {
                primary: "#89d5dc",
                secondary: "#6bb1b8",
                background: "#0c0c0c"
              }
            },
            
            // Jupiter Ultra API referral configuration
            feeBps: REFERRAL_CONFIG.feeBps,
            feeRecipient: REFERRAL_CONFIG.feeRecipient,
            
            // Event handlers for Ultra API integration
            onSuccess: ({ txSignature, inputMint, outputMint, inputAmount, outputAmount }) => {
              console.log("🎉 Swap successful!", {
                transaction: txSignature,
                input: { mint: inputMint, amount: inputAmount },
                output: { mint: outputMint, amount: outputAmount }
              });
              
              // Process referral fee for supported tokens
              const inputToken = Object.values(SUPPORTED_TOKENS).includes(inputMint);
              const outputToken = Object.values(SUPPORTED_TOKENS).includes(outputMint);
              
              if (inputToken || outputToken) {
                handleUltraReferralFee(txSignature);
              } else {
                console.log("No referral fee applied - tokens not in supported list");
              }
            },
            
            onError: ({ error }) => {
              console.error("❌ Swap failed:", error);
              showStatusMessage(`Swap failed: ${error.message || 'Unknown error'}`, 'error');
            }
          });
          
          console.log("🚀 Jupiter Ultra widget initialized successfully");
          showStatusMessage('Jupiter Ultra widget ready!', 'success');
          
        } catch (error) {
          console.error("❌ Widget initialization failed:", error);
          showStatusMessage(`Widget initialization failed: ${error.message}`, 'error');
        }
      };

      // Start initialization
      initWidget();
    });

    // Claim fees button event handler
    document.getElementById("claimFeesBtn").addEventListener("click", checkUnclaimedFees);

    // Additional Ultra API utility functions
    
    /**
     * Check if a token is eligible for referral fees
     * @param {string} mintAddress - Token mint address
     * @returns {boolean} - Whether token is supported
     */
    function isTokenSupported(mintAddress) {
      return Object.values(SUPPORTED_TOKENS).includes(mintAddress);
    }

    /**
     * Get token symbol from mint address
     * @param {string} mintAddress - Token mint address  
     * @returns {string} - Token symbol or 'UNKNOWN'
     */
    function getTokenSymbol(mintAddress) {
      const entry = Object.entries(SUPPORTED_TOKENS).find(([, address]) => address === mintAddress);
      return entry ? entry[0] : 'UNKNOWN';
    }

    /**
     * Format fee amount for display
     * @param {number} amount - Fee amount in native units
     * @param {number} decimals - Token decimals
     * @returns {string} - Formatted amount
     */
    function formatFeeAmount(amount, decimals = 9) {
      return (amount / Math.pow(10, decimals)).toFixed(6);
    }

    // Export configuration for external use
    window.OppoConfig = {
      REFERRAL_CONFIG,
      SUPPORTED_TOKENS,
      handleUltraReferralFee,
      checkUnclaimedFees,
      isTokenSupported,
      getTokenSymbol,
      formatFeeAmount
    };

  </script>
</body>
</html>