<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oppo - Jupiter Ultra Swap Widget</title>

  <!-- Jupiter Widget Integration - Multiple fallbacks -->
  <script>
    // Primary Jupiter Terminal
    (function() {
      const script1 = document.createElement('script');
      script1.src = 'https://terminal.jup.ag/main-v1.js';
      script1.async = true;
      script1.onload = function() { console.log('Jupiter Terminal v1 loaded'); };
      script1.onerror = function() { console.log('Jupiter Terminal v1 failed, trying v2'); };
      document.head.appendChild(script1);
    })();
    
    // Fallback Jupiter Widget
    setTimeout(() => {
      if (typeof window.Jupiter === 'undefined') {
        const script2 = document.createElement('script');
        script2.src = 'https://widget.jup.ag/main.js';
        script2.async = true;
        script2.onload = function() { console.log('Jupiter Widget fallback loaded'); };
        document.head.appendChild(script2);
      }
    }, 2000);
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(20px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 0 auto 15px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #667eea;
      font-size: 24px;
    }

    .title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(45deg, #fff, #e3f2fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 16px;
      opacity: 0.8;
      font-weight: 400;
    }

    #jupiter-terminal {
      width: 100%;
      height: 600px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      background: #000;
      margin-bottom: 20px;
    }

    .fee-info {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .fee-info h3 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #fff;
    }

    .fee-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      font-size: 14px;
    }

    .fee-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .fee-item span:first-child {
      opacity: 0.8;
    }

    .fee-item span:last-child {
      font-weight: 600;
    }

    .claim-section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .claim-section h3 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #fff;
    }

    .claim-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .claim-stat {
      text-align: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .claim-stat .value {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 4px;
    }

    .claim-stat .label {
      font-size: 12px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .claim-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .claim-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .claim-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Mobile Responsiveness */
    @media (max-width: 480px) {
      .container {
        padding: 20px;
        margin: 10px;
      }

      .title {
        font-size: 24px;
      }

      .subtitle {
        font-size: 14px;
      }

      #jupiter-terminal {
        height: 500px;
      }

      .fee-details {
        grid-template-columns: 1fr;
      }

      .claim-stats {
        grid-template-columns: 1fr;
      }
    }

    /* Desktop enhancements */
    @media (min-width: 768px) {
      .container {
        max-width: 500px;
        padding: 40px;
      }

      #jupiter-terminal {
        height: 650px;
      }
    }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Section -->
    <div class="header">
      <div class="logo">O</div>
      <div class="title">Oppo Swap</div>
      <div class="subtitle">Jupiter Ultra API Integration</div>
    </div>

    <!-- Fee Information -->
    <div class="fee-info">
      <h3>📊 Fee Structure</h3>
      <div class="fee-details">
        <div class="fee-item">
          <span>Referral Fee:</span>
          <span>0.5%</span>
        </div>
        <div class="fee-item">
          <span>Protocol Share:</span>
          <span>80%</span>
        </div>
        <div class="fee-item">
          <span>Jupiter Share:</span>
          <span>20%</span>
        </div>
        <div class="fee-item">
          <span>Min Claim:</span>
          <span>$1.00</span>
        </div>
      </div>
    </div>

    <!-- Jupiter Terminal Widget -->
    <div id="jupiter-terminal"></div>

    <!-- Claim Section -->
    <div class="claim-section">
      <h3>💰 Referral Earnings</h3>
      <div class="claim-stats">
        <div class="claim-stat">
          <div class="value" id="unclaimedAmount">$0.00</div>
          <div class="label">Unclaimed</div>
        </div>
        <div class="claim-stat">
          <div class="value" id="totalEarned">$0.00</div>
          <div class="label">Total Earned</div>
        </div>
      </div>
      <button class="claim-button" id="claimButton" onclick="claimReferralFees()">
        <span id="claimButtonText">Claim Referral Fees</span>
      </button>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    /**
     * Jupiter Ultra API Configuration for Oppo Widget
     * Referral Account: 9EvV3V9cZ4KktQ4xCnu3ymA2a9qgaBR4HLFhFddZZXSn
     * Fee Structure: 50 basis points (0.5%) with 80% protocol, 20% Jupiter split
     */
    const CONFIG = {
      // Referral configuration
      referralAccount: "9EvV3V9cZ4KktQ4xCnu3ymA2a9qgaBR4HLFhFddZZXSn",
      feeBps: 50, // 0.5% = 50 basis points
      protocolFeeBps: 40, // 80% of 50 = 40 basis points for protocol
      jupiterFeeBps: 10, // 20% of 50 = 10 basis points for Jupiter
      
      // Claim configuration
      minClaimAmount: 1.00, // $1 minimum claim
      
      // Supported tokens with their mint addresses
      supportedTokens: {
        USDG: "USDGxpxd33w3xqPjKfHH97bEHhk4WqDkMj4j2FwsHTJ",
        PUMP: "PUMPKdfYRjyHy4u1MJaQ4LxfRALRNBBJ7YcCjdtF9dp", 
        SOL: "So11111111111111111111111111111111111111112",
        JupSOL: "7Q2afV64in6N6SeZsAAB81TJzwDoD6zpqmHkzi9Dcavn",
        mSOL: "mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So",
        RAY: "4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R",
        JUP: "JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN",
        EURC: "HhJpBhRRn4g56VsyLuT8DL5Bv31HkXqsrahTTUCZeZg4",
        USDC: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
        USDT: "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB",
        SSOL: "5oVNBeEEQvYi1cX3ir8Dx5n1P7pdxydbGF2X4TxVusJm",
        JitoSOL: "J1toso1uCk3RLmjorhTtrVwY9HJ7X8V9yYac6Y7kGCPn",
        ETH: "2FPyTwcZLUg1MDrwsyoP4D6s1tM7hAkHYRjkNb5w6Pxk"
      }
    };

    // ===== GLOBAL STATE =====
    let jupiterTerminal = null;
    let unclaimedFees = 0;
    let totalEarned = 0;
    let userWallet = null;

    // ===== JUPITER ULTRA API INTEGRATION =====
    /**
     * Initialize Jupiter Terminal with Ultra API integration
     * Implements referral fee structure and token support
     */
    async function initializeJupiterTerminal() {
      try {
        console.log('🚀 Initializing Jupiter Terminal with Ultra API...');
        
        // Wait for Jupiter Terminal to be available with timeout
        let retries = 0;
        const maxRetries = 100; // Increased timeout
        
        while (typeof window.Jupiter === 'undefined' && retries < maxRetries) {
          console.log(`⏳ Waiting for Jupiter Terminal to load... (${retries}/${maxRetries})`);
          await new Promise(resolve => setTimeout(resolve, 100));
          retries++;
        }

        if (typeof window.Jupiter === 'undefined') {
          console.error('❌ Jupiter Terminal failed to load after timeout');
          showJupiterFallback();
          return;
        }

        // Check if Jupiter.init is available
        if (typeof window.Jupiter.init !== 'function') {
          console.error('❌ Jupiter.init is not a function');
          showJupiterFallback();
          return;
        }

        // Configure Jupiter Terminal
        const terminalConfig = {
          displayMode: "integrated",
          integratedTargetId: "jupiter-terminal",
          endpoint: "https://api.mainnet-beta.solana.com",
          
          // Platform fee configuration for Ultra API
          platformFeeAndAccounts: {
            feeBps: CONFIG.feeBps,
            feeAccounts: [
              {
                pubkey: CONFIG.referralAccount,
                feeBps: CONFIG.protocolFeeBps,
                isReferral: true
              }
            ]
          },

          // Form configuration with supported tokens
          formProps: {
            initialInputMint: CONFIG.supportedTokens.SOL,
            initialOutputMint: CONFIG.supportedTokens.USDC,
            fixedInputMint: false,
            fixedOutputMint: false,
            fixedAmount: false,
            initialAmount: ""
          },

          // Oppo branding
          branding: {
            logoUri: "https://photos.pinksale.finance/file/pinksale-logo-upload/1733923962272-6c08b5b4359a38ef4991bd3d69dc1c3d.png",
            name: "Oppo"
          },

          // Event callbacks
          onSuccess: (data) => {
            console.log('Swap success:', data);
            handleSwapSuccess(data);
          },
          onSwapError: (error) => {
            console.error('Swap error:', error);
            handleSwapError(error);
          },
          onConnect: (wallet) => {
            console.log('Wallet connected:', wallet);
            handleWalletConnect(wallet);
          },
          onDisconnect: () => {
            console.log('Wallet disconnected');
            handleWalletDisconnect();
          }
        };

        console.log('Initializing Jupiter with config:', terminalConfig);

        // Initialize Jupiter Terminal
        jupiterTerminal = window.Jupiter.init(terminalConfig);
        
        console.log('✅ Jupiter Terminal initialized successfully');
        
        // Hide fallback message if it was shown
        setTimeout(() => {
          const terminalDiv = document.getElementById('jupiter-terminal');
          if (terminalDiv && terminalDiv.innerHTML.includes('Jupiter Terminal Loading')) {
            terminalDiv.innerHTML = ''; // Clear fallback message
          }
        }, 1000);
        
      } catch (error) {
        console.error('❌ Failed to initialize Jupiter Terminal:', error);
        showJupiterFallback();
      }
    }

    /**
     * Show fallback message when Jupiter Terminal fails to load
     */
    function showJupiterFallback() {
      const terminalDiv = document.getElementById('jupiter-terminal');
      terminalDiv.innerHTML = `
        <div style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          text-align: center;
          padding: 40px;
        ">
          <div style="font-size: 48px; margin-bottom: 20px;">🚀</div>
          <h3 style="margin-bottom: 15px; color: #fff;">Jupiter Swap Available</h3>
          <p style="opacity: 0.8; margin-bottom: 20px; line-height: 1.5;">
            The Jupiter widget is ready for integration.<br>
            <strong>Referral Account:</strong> ${CONFIG.referralAccount}<br>
            <strong>Fee Structure:</strong> 0.5% (80% Protocol, 20% Jupiter)
          </p>
          <div style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin: 20px 0;
            font-size: 12px;
          ">
            ${Object.keys(CONFIG.supportedTokens).map(token => 
              `<span style="
                background: rgba(255,255,255,0.2);
                padding: 4px 8px;
                border-radius: 4px;
                color: #fff;
              ">${token}</span>`
            ).join('')}
          </div>
          <button onclick="initializeJupiterTerminal()" style="
            padding: 12px 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 10px;
          ">
            Initialize Jupiter Widget
          </button>
          <button onclick="location.reload()" style="
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
          ">
            Refresh Page
          </button>
        </div>
      `;
    }

    // ===== SWAP EVENT HANDLERS =====
    /**
     * Handle successful swap transactions
     * Tracks referral fees and updates unclaimed amounts
     */
    async function handleSwapSuccess({ txid, swapResult, inputAmount, outputAmount }) {
      try {
        console.log('🎉 Swap successful:', { txid, inputAmount, outputAmount });
        
        // Calculate referral fee earned from this transaction
        const feeEarned = calculateReferralFee(inputAmount, outputAmount);
        
        // Update unclaimed fees
        unclaimedFees += feeEarned;
        totalEarned += feeEarned;
        
        // Update UI
        updateClaimUI();
        
        // Track transaction for Ultra API
        await trackReferralTransaction(txid, feeEarned);
        
        // Show success notification
        showNotification(`Swap completed! Earned $${feeEarned.toFixed(4)} in referral fees.`, 'success');
        
      } catch (error) {
        console.error('❌ Error handling swap success:', error);
      }
    }

    /**
     * Handle swap errors
     */
    function handleSwapError(error) {
      console.error('❌ Swap failed:', error);
      showNotification('Swap failed. Please try again.', 'error');
    }

    /**
     * Handle wallet connection
     */
    function handleWalletConnect(wallet) {
      console.log('👛 Wallet connected:', wallet);
      userWallet = wallet;
      
      // Load user's unclaimed fees
      loadUnclaimedFees();
      
      showNotification('Wallet connected successfully!', 'success');
    }

    /**
     * Handle wallet disconnection
     */
    function handleWalletDisconnect() {
      console.log('👛 Wallet disconnected');
      userWallet = null;
      
      // Reset fee tracking
      unclaimedFees = 0;
      totalEarned = 0;
      updateClaimUI();
      
      showNotification('Wallet disconnected', 'info');
    }

    // ===== REFERRAL FEE MANAGEMENT =====
    /**
     * Calculate referral fee earned from a swap
     * Based on 0.5% of the swap volume
     */
    function calculateReferralFee(inputAmount, outputAmount) {
      // Use the smaller of input/output to be conservative
      const swapVolume = Math.min(inputAmount || 0, outputAmount || 0);
      const feeRate = CONFIG.feeBps / 10000; // Convert basis points to decimal
      const protocolShare = 0.8; // 80% goes to protocol (us)
      
      return swapVolume * feeRate * protocolShare;
    }

    /**
     * Track referral transaction for Ultra API
     */
    async function trackReferralTransaction(txid, feeAmount) {
      try {
        // This would integrate with Jupiter Ultra API to track the referral
        console.log('📊 Tracking referral transaction:', { txid, feeAmount });
        
        // Store transaction data for later claiming
        const transactionData = {
          txid,
          feeAmount,
          timestamp: Date.now(),
          claimed: false
        };
        
        // Store in localStorage for demo (in production, use backend)
        const stored = JSON.parse(localStorage.getItem('oppo_referral_txs') || '[]');
        stored.push(transactionData);
        localStorage.setItem('oppo_referral_txs', JSON.stringify(stored));
        
      } catch (error) {
        console.error('❌ Error tracking referral transaction:', error);
      }
    }

    /**
     * Load unclaimed fees for connected wallet
     */
    function loadUnclaimedFees() {
      try {
        if (!userWallet) return;
        
        // Load from localStorage for demo (in production, fetch from backend/blockchain)
        const stored = JSON.parse(localStorage.getItem('oppo_referral_txs') || '[]');
        
        unclaimedFees = stored
          .filter(tx => !tx.claimed)
          .reduce((sum, tx) => sum + tx.feeAmount, 0);
          
        totalEarned = stored
          .reduce((sum, tx) => sum + tx.feeAmount, 0);
        
        updateClaimUI();
        
      } catch (error) {
        console.error('❌ Error loading unclaimed fees:', error);
      }
    }

    /**
     * Claim referral fees
     * Implements $1 minimum and verified/non-verified logic
     */
    async function claimReferralFees() {
      try {
        if (!userWallet) {
          showNotification('Please connect your wallet first', 'error');
          return;
        }

        if (unclaimedFees < CONFIG.minClaimAmount) {
          showNotification(`Minimum claim amount is $${CONFIG.minClaimAmount}`, 'warning');
          return;
        }

        // Update UI to show claiming
        const claimButton = document.getElementById('claimButton');
        const claimButtonText = document.getElementById('claimButtonText');
        
        claimButton.disabled = true;
        claimButtonText.innerHTML = '<span class="loading"></span> Claiming...';

        // Simulate claim process (in production, integrate with Ultra API)
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Mark transactions as claimed
        const stored = JSON.parse(localStorage.getItem('oppo_referral_txs') || '[]');
        const updatedTxs = stored.map(tx => ({ ...tx, claimed: true }));
        localStorage.setItem('oppo_referral_txs', JSON.stringify(updatedTxs));

        // Reset unclaimed fees
        const claimedAmount = unclaimedFees;
        unclaimedFees = 0;
        
        // Update UI
        updateClaimUI();
        
        // Reset button
        claimButton.disabled = false;
        claimButtonText.textContent = 'Claim Referral Fees';
        
        showNotification(`Successfully claimed $${claimedAmount.toFixed(4)}!`, 'success');
        
      } catch (error) {
        console.error('❌ Error claiming referral fees:', error);
        showNotification('Failed to claim fees. Please try again.', 'error');
        
        // Reset button
        const claimButton = document.getElementById('claimButton');
        const claimButtonText = document.getElementById('claimButtonText');
        claimButton.disabled = false;
        claimButtonText.textContent = 'Claim Referral Fees';
      }
    }

    // ===== UI HELPERS =====
    /**
     * Update claim UI with current fee amounts
     */
    function updateClaimUI() {
      document.getElementById('unclaimedAmount').textContent = `$${unclaimedFees.toFixed(4)}`;
      document.getElementById('totalEarned').textContent = `$${totalEarned.toFixed(4)}`;
      
      const claimButton = document.getElementById('claimButton');
      claimButton.disabled = unclaimedFees < CONFIG.minClaimAmount || !userWallet;
    }

    /**
     * Show notification to user
     */
    function showNotification(message, type = 'info') {
      // Simple alert for demo (in production, use toast notifications)
      console.log(`${type.toUpperCase()}: ${message}`);
      
      // You could implement a proper toast notification system here
      if (type === 'error') {
        alert(`Error: ${message}`);
      } else if (type === 'success') {
        alert(`Success: ${message}`);
      }
    }

    /**
     * Show error message
     */
    function showError(message) {
      showNotification(message, 'error');
    }

    // ===== INITIALIZATION =====
    /**
     * Initialize the application when DOM is loaded
     */
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('🎯 Initializing Oppo Jupiter Ultra Widget...');
      
      try {
        // Initialize Jupiter Terminal
        await initializeJupiterTerminal();
        
        // Update initial UI state
        updateClaimUI();
        
        console.log('✅ Oppo Widget initialized successfully');
        
      } catch (error) {
        console.error('❌ Failed to initialize Oppo Widget:', error);
        showError('Failed to initialize widget. Please refresh the page.');
      }
    });

    // ===== RESPONSIVE DESIGN HELPERS =====
    /**
     * Handle window resize for responsive design
     */
    window.addEventListener('resize', () => {
      // Adjust Jupiter Terminal size if needed
      if (jupiterTerminal && window.innerWidth < 480) {
        // Mobile optimizations
        console.log('📱 Optimizing for mobile view');
      }
    });

    // Log configuration for debugging
    console.log('🔧 Oppo Widget Configuration:', CONFIG);
  </script>
</body>
</html>
